<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ³ÙØ³ | Ù„ÙˆØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .test-card {
            padding: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-ok {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .status-error {
            background: #f87171;
            box-shadow: 0 0 10px #f87171;
        }

        .log-box {
            background: #000;
            color: #0f0;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <nav class="navbar glass">
        <div class="nav-container">
            <a href="index.html" class="logo">ÙØ³ÙØ³ - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</a>
            <div class="nav-actions">
                <button onclick="location.reload()" class="btn btn-primary">Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ ğŸ”„</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="test-grid">
            <!-- API Status -->
            <div class="test-card glass">
                <h3>ğŸŒ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± (API)</h3>
                <p id="apiStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ... <span class="status-indicator"></span></p>
                <div id="apiLog" class="log-box"></div>
            </div>

            <!-- Socket Status -->
            <div class="test-card glass">
                <h3>ğŸ”Œ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙƒÙŠØª (Socket.io)</h3>
                <p id="socketStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ... <span class="status-indicator"></span></p>
                <div id="socketLog" class="log-box"></div>
            </div>

            <!-- Auth Status -->
            <div class="test-card glass">
                <h3>ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Auth)</h3>
                <p id="authStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ... <span class="status-indicator"></span></p>
                <div id="authLog" class="log-box"></div>
            </div>

            <!-- Feature Test -->
            <div class="test-card glass">
                <h3>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙŠØ²Ø§Øª</h3>
                <div style="display:flex; gap:10px; flex-direction:column;">
                    <button class="btn btn-outline" onclick="testChat()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ğŸ’¬</button>
                    <button class="btn btn-outline" onclick="testBuzz()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‡ØªØ²Ø§Ø² (Buzz) âš¡</button>
                    <button class="btn btn-outline" onclick="testRadio()">ØªØ´ØºÙŠÙ„ Ø±Ø§Ø¯ÙŠÙˆ Ø§ÙØªØ±Ø§Ø¶ÙŠ ğŸ“»</button>
                </div>
            </div>
        </div>

        <div style="padding: 20px;">
            <div class="test-card glass">
                <h3>ğŸ’¬ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Live)</h3>
                <div id="testMessages"
                    style="height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 10px;">
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="config.js"></script>
    <script>
        function log(id, msg, type = 'info') {
            const box = document.getElementById(id);
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div>[${time}] <span style="color:${type === 'error' ? '#f87171' : '#4ade80'}">${msg}</span></div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function runTests() {
            if (!window.AppConfig) {
                document.getElementById('apiStatus').innerHTML = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âŒ <span class="status-indicator status-error"></span>`;
                log('apiLog', 'Ù…Ù„Ù config.js Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø£Ùˆ AppConfig ØºÙŠØ± Ù…Ø¹Ø±Ù', 'error');
                return;
            }

            const apiUrl = window.AppConfig.apiUrl;
            const socketUrl = window.AppConfig.socketUrl;

            // 1. API Test
            try {
                const start = Date.now();
                const res = await fetch(`${apiUrl}/radio/state`);
                const duration = Date.now() - start;
                if (res.ok) {
                    document.getElementById('apiStatus').innerHTML = `Ù…ØªØµÙ„ âœ… (${duration}ms) <span class="status-indicator status-ok"></span>`;
                    log('apiLog', 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    throw new Error('Server returned ' + res.status);
                }
            } catch (e) {
                document.getElementById('apiStatus').innerHTML = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ <span class="status-indicator status-error"></span>`;
                log('apiLog', e.message, 'error');
            }

            // 2. Auth Test
            const token = localStorage.getItem('fsfs_token');
            if (!token) {
                document.getElementById('authStatus').innerHTML = `ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ âš ï¸ <span class="status-indicator status-error"></span>`;
                log('authLog', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† (fsfs_token) ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­', 'error');
            } else {
                try {
                    const res = await fetch(`${apiUrl}/auth/me`, {
                        headers: { 'Authorization': token }
                    });
                    if (res.ok) {
                        const user = await res.json();
                        document.getElementById('authStatus').innerHTML = `Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³Ù…: ${user.username} âœ… <span class="status-indicator status-ok"></span>`;
                        log('authLog', 'Ø§Ù„ØªÙˆÙƒÙ† ØµØ§Ù„Ø­ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + user.username);
                        initSocketTest(token, socketUrl);
                    } else {
                        throw new Error('Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ');
                    }
                } catch (e) {
                    document.getElementById('authStatus').innerHTML = `ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ âŒ <span class="status-indicator status-error"></span>`;
                    log('authLog', e.message, 'error');
                }
            }
        }

        let socket;
        function initSocketTest(token, socketUrl) {
            socket = io(socketUrl, { auth: { token } });

            socket.on('connect', () => {
                document.getElementById('socketStatus').innerHTML = `Ù…ØªØµÙ„ âœ… <span class="status-indicator status-ok"></span>`;
                log('socketLog', 'ØªÙ… ÙØªØ­ Ù‚Ù†Ø§Ø© Socket Ø¨Ù†Ø¬Ø§Ø­ ID: ' + socket.id);
                socket.emit('join_chat');
            });

            socket.on('connect_error', (err) => {
                document.getElementById('socketStatus').innerHTML = `Ø®Ø·Ø£ Ø³ÙˆÙƒÙŠØª âŒ <span class="status-indicator status-error"></span>`;
                log('socketLog', 'ÙØ´Ù„ Ø§Ù„Ø³ÙˆÙƒÙŠØª: ' + err.message, 'error');
            });

            socket.on('receive_message', (msg) => {
                log('testMessages', `${msg.username}: ${msg.content}`);
                const div = document.createElement('div');
                div.style.padding = '5px';
                div.innerHTML = `<strong>${msg.username}:</strong> ${msg.content}`;
                document.getElementById('testMessages').appendChild(div);
            });

            socket.on('user_buzz', (data) => {
                log('socketLog', `ğŸš¨ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù‡ØªØ²Ø§Ø² Ù…Ù†: ${data.username}`);
                document.body.style.background = 'red';
                setTimeout(() => document.body.style.background = '', 100);
            });
        }

        function testChat() {
            if (!socket) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!');
            socket.emit('send_message', { content: 'Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† ØµÙØ­Ø© Ø§Ù„ÙØ­Øµ ğŸ§ª' });
            log('socketLog', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±');
        }

        function testBuzz() {
            if (!socket) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!');
            socket.emit('send_buzz');
            log('socketLog', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‡ØªØ²Ø§Ø²');
        }

        function testRadio() {
            if (!socket) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!');
            socket.emit('update_radio', { youtube_id: 'jfKfPfyJRdk' });
            log('socketLog', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ');
        }

        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>

</html>